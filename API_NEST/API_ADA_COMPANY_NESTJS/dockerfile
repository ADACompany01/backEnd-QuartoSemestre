# Etapa 1: build (Nenhuma mudança aqui)
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
COPY tsconfig*.json ./
COPY . .
RUN npm install
RUN npm run build

# Etapa 2: imagem final (Versão Corrigida)
FROM node:20-alpine
WORKDIR /app

# 1. Copia o package.json
COPY --from=builder /app/package*.json ./

# 2. Instala APENAS as dependências de PRODUÇÃO
RUN npm install --production

# 3. Copia os arquivos compilados (javascript)
# Verifique este caminho! Se seu build gera 'dist/main.js',
# esta linha deve ser 'COPY --from=builder /app/dist ./dist'
COPY --from=builder /app/dist ./dist 

# 4. Expõe a porta e inicia
EXPOSE 3000
CMD ["node", "dist/main.js"]